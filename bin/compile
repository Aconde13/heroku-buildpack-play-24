#!/usr/bin/env bash
set -e
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

source "$BUILD_DIR/bin/common.sh"

echo "-----> Installing Python 2.7..."
/usr/bin/curl -L -o python2.tgz "https://github.com/Cliengo/heroku-buildpack-play-24/releases/download/heroku-24/Python-2.7.18.tgz"
mkdir -p .python2
tar -xzf python2.tgz -C .python2 --strip-components=1
rm python2.tgz
echo "-----> Python 2.7 installed."

echo "-----> Installing OpenJDK..."
JDK_URL="https://github.com/Cliengo/heroku-buildpack-play-24/releases/download/heroku-24/jre-8u431-linux-x64.tar.gz"
JDK_DIR="$BUILD_DIR/.jdk"
mkdir -p "$JDK_DIR"
install_openjdk

echo "-----> Installing Play! Framework..."
PLAY_VERSION=$(grep -i "play" conf/dependencies.yml | head -1 | awk '{print $2}')
PLAY_PATH="$BUILD_DIR/.play"

if [ ! -f "$PLAY_PATH/play" ]; then
  download_play_official "$PLAY_VERSION" "$PLAY_PATH"
else
  INSTALLED_PLAY_VERSION=$(cat "$PLAY_PATH/framework/src/play/version")
  if [ "$INSTALLED_PLAY_VERSION" != "$PLAY_VERSION" ]; then
    echo "-----> Updating Play! from $INSTALLED_PLAY_VERSION to $PLAY_VERSION..."
    rm -rf "$PLAY_PATH"
    download_play_official "$PLAY_VERSION" "$PLAY_PATH"
  fi
fi

echo "-----> Build complete."
